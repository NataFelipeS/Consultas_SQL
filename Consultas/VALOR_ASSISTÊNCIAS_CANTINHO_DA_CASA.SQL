SELECT 
  P.CODIGO_PESSOA,
  P.RAZAOSOCIAL_PESSOA,
  DF.CODIGO_DOCFAT,
  DF.DTEMISSAO_DOCFAT,
  SUM(DI.VLRTOTALBRUTO_DOCITEM) AS TOTAL_ITENS,

  COALESCE((
    SELECT DM.VALOR_DOCMANIF 
    FROM DOCUMENTOS_MANIFESTACAO DM 
    WHERE DM.CODIGODEST_DOCMANIF = P.CODIGO_PESSOA 
      AND DM.EMISSAO_DOCMANIF = (
        SELECT MAX(DM2.EMISSAO_DOCMANIF)
        FROM DOCUMENTOS_MANIFESTACAO DM2
        WHERE DM2.CODIGODEST_DOCMANIF = P.CODIGO_PESSOA
          AND DM2.EMISSAO_DOCMANIF BETWEEN '2025-02-01' AND '2025-03-01'
      )
    ROWS 1
  ), 0) AS VALOR_DOCMANIF,

  SUM(DI.VLRTOTALBRUTO_DOCITEM) + COALESCE((
    SELECT DM.VALOR_DOCMANIF 
    FROM DOCUMENTOS_MANIFESTACAO DM 
    WHERE DM.CODIGODEST_DOCMANIF = P.CODIGO_PESSOA 
      AND DM.EMISSAO_DOCMANIF = (
        SELECT MAX(DM2.EMISSAO_DOCMANIF)
        FROM DOCUMENTOS_MANIFESTACAO DM2
        WHERE DM2.CODIGODEST_DOCMANIF = P.CODIGO_PESSOA
          AND DM2.EMISSAO_DOCMANIF BETWEEN '2025-02-01' AND '2025-03-01'
      )
    ROWS 1
  ), 0) AS TOTAL_GERAL

FROM DOCUMENTO_FATURA DF
INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DF.CLIENTE_DOCFAT
INNER JOIN DOCUMENTO_ITEM DI ON DI.DOCUMENTO_DOCITEM = DF.CODIGO_DOCFAT

WHERE DF.TIPO_DOCFAT = 2 
  AND DF.USUARIOINCLUSAO_DOCFAT = 'E-COMMERCE03'
  AND cast(DF.DTEMISSAO_DOCFAT as date) BETWEEN '2025-02-01' AND '2025-03-01'

GROUP BY 
  P.CODIGO_PESSOA,
  P.RAZAOSOCIAL_PESSOA,
  DF.CODIGO_DOCFAT,
  DF.DTEMISSAO_DOCFAT
ORDER BY DTEMISSAO_DOCFAT DESC;

-- NICIOLI