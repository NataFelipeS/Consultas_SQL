WITH ULTIMA_COMPRA (CLIENTE, TIPO, NOME, TEL, REGIAO, ULTIMA, DIAS, VALOR, MEDIA, VENDAS) AS (
SELECT
    DF.CLIENTE_DOCFAT AS CLIENTE,
    P.TIPO_PESSOA AS TIPO,
    P.RAZAOSOCIAL_PESSOA AS NOME,
    MAX(PT.TELEFONE_PESSOA_TEL) AS TEL,
    R.DESCRICAO_REGIAO AS REGIAO,
    MAX(NF.DATAEMISSAO_NF) AS ULTIMA,
    CURRENT_DATE - CAST(MAX(NF.DATAEMISSAO_NF) AS DATE) AS DIAS,
    SUM(NF.VALORTOTAL_NF) AS VALOR,
    AVG(NF.VALORTOTAL_NF) AS MEDIA,
    COUNT(NF.AUTOINC_NF) AS VENDAS
FROM NOTA_FISCAL NF
    INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
    INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DF.CLIENTE_DOCFAT
    INNER JOIN PESSOA_ENDERECO PE ON PE.AUTOINC_PESSOA_END = NF.ENDERECO_NF
    INNER JOIN REGIAO R ON R.CODIGO_REGIAO = PE.REGIAO_PESSOA_END
    LEFT JOIN (
        SELECT T1.PESSOA_PESSOA_TEL, T1.TELEFONE_PESSOA_TEL
        FROM PESSOA_TELEFONE T1
        WHERE T1.DATAHORAINCLUSAO_PESSOA_TEL = (
            SELECT MAX(T2.DATAHORAINCLUSAO_PESSOA_TEL)
            FROM PESSOA_TELEFONE T2
            WHERE T2.PESSOA_PESSOA_TEL = T1.PESSOA_PESSOA_TEL
        )
    ) PT ON PT.PESSOA_PESSOA_TEL = P.CODIGO_PESSOA
WHERE 
    NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
    DF.CLASSIFICACAO_DOCFAT = 1 AND
    P.TIPO_PESSOA = 'J' AND
    NF.DATAEMISSAO_NF BETWEEN Filtro(2, 0) AND CURRENT_DATE
GROUP BY
    DF.CLIENTE_DOCFAT,
    R.DESCRICAO_REGIAO,
    P.TIPO_PESSOA,
    P.RAZAOSOCIAL_PESSOA
   -- PT.TELEFONE_PESSOA_TEL
ORDER BY
    REGIAO
)
SELECT 
    CLIENTE,
    NOME,
    REGIAO,
    TEL,
    ULTIMA, 
    DIAS,
    VALOR,
    MEDIA,
    VENDAS,
    SUM(CASE WHEN DIAS >= Filtro(4) THEN 1 ELSE 0 END) OVER() AS CONTA
FROM ULTIMA_COMPRA
WHERE DIAS >= Filtro(4)
