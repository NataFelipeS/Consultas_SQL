SELECT
	CASE EXTRACT(WEEKDAY FROM DC.DATAHORAINCLUSAO_DOCCOM)
	WHEN 1 THEN 'Segunda'
	WHEN 2 THEN 'Terça'
	WHEN 3 THEN 'Quarta'
	WHEN 4 THEN 'Quinta'
	WHEN 5 THEN 'Sexta'
	WHEN 6 THEN 'Sábado'
	WHEN 7 THEN 'Domingo' END AS dias_da_semana,
	P.CODIGO_PESSOA,
	P.RAZAOSOCIAL_PESSOA,
	SUM(NF.VALORTOTAL_NF) AS SOMA
FROM DOCUMENTO_COMISSAO DC
	INNER JOIN PESSOA P ON DC.PESSOA_DOCCOM = P.CODIGO_PESSOA
	INNER JOIN NOTA_FISCAL NF ON DC.DOCUMENTO_DOCCOM = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
	INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = DC.DOCUMENTO_DOCCOM
WHERE 
	P.RAZAOSOCIAL_PESSOA LIKE 'TELEVENDAS01' AND
	NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
	DF.CLASSIFICACAO_DOCFAT = 1
GROUP BY
	EXTRACT(WEEKDAY FROM DC.DATAHORAINCLUSAO_DOCCOM),
	P.CODIGO_PESSOA,
	P.RAZAOSOCIAL_PESSOA
	
	
	WITH DIA AS (
SELECT
	COD_DIA,
	DIAS_DA_SEMANA,
	CODIGO,
	NOME,
	SOMA_DIA
FROM (
SELECT
	EXTRACT(WEEKDAY FROM DC.DATAHORAINCLUSAO_DOCCOM) AS COD_DIA,
	CASE EXTRACT(WEEKDAY FROM DC.DATAHORAINCLUSAO_DOCCOM)
	WHEN 0 THEN 'Domingo'
	WHEN 1 THEN 'Segunda'
	WHEN 2 THEN 'Terça'
	WHEN 3 THEN 'Quarta'
	WHEN 4 THEN 'Quinta'
	WHEN 5 THEN 'Sexta'
	WHEN 6 THEN 'Sábado' END AS dias_da_semana,
	P.CODIGO_PESSOA AS CODIGO,
	P.RAZAOSOCIAL_PESSOA AS NOME,
	SUM(NF.VALORTOTAL_NF) AS SOMA_DIA
FROM DOCUMENTO_COMISSAO DC
	INNER JOIN PESSOA P ON DC.PESSOA_DOCCOM = P.CODIGO_PESSOA
	INNER JOIN NOTA_FISCAL NF ON DC.DOCUMENTO_DOCCOM = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
	INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = DC.DOCUMENTO_DOCCOM
WHERE 
	P.STATUS_PESSOA = 0 AND
	NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
	DF.CLASSIFICACAO_DOCFAT = 1
GROUP BY
	EXTRACT(WEEKDAY FROM DC.DATAHORAINCLUSAO_DOCCOM),
	P.CODIGO_PESSOA,
	P.RAZAOSOCIAL_PESSOA
)),
TOTAL AS (
SELECT
	P.CODIGO_PESSOA AS COD,
	P.RAZAOSOCIAL_PESSOA AS NOM,
	SUM(NF.VALORTOTAL_NF) AS SOMA
FROM DOCUMENTO_COMISSAO DC
	INNER JOIN PESSOA P ON DC.PESSOA_DOCCOM = P.CODIGO_PESSOA
	INNER JOIN NOTA_FISCAL NF ON DC.DOCUMENTO_DOCCOM = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
	INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = DC.DOCUMENTO_DOCCOM
WHERE 
	P.STATUS_PESSOA = 0 AND
	NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
	DF.CLASSIFICACAO_DOCFAT = 1
GROUP BY
	P.CODIGO_PESSOA,
	P.RAZAOSOCIAL_PESSOA
),
BASE AS (
SELECT
	D.DIAS_DA_SEMANA,
	D.CODIGO,
	D.NOME,
	D.SOMA_DIA,
	CAST((D.SOMA_DIA / T.SOMA) * 100 AS NUMERIC(10,2)) AS PERCENTUAL,
	T.SOMA
FROM DIA D
INNER JOIN TOTAL T ON T.COD = D.CODIGO
)
SELECT
	NOME,
	DOM,
	ROUND(DOM * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_DOM,
	SEG,
	ROUND(SEG * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_SEG,
	TER,
	ROUND(TER * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_TER,
	QUA,
	ROUND(QUA * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_QUA,
	QUI,
	ROUND(QUI * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_QUI,
	SEX,
	ROUND(SEX * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_SEX,
	SAB,
	ROUND(SAB * 100.0 / NULLIF(TOTAL,0), 2) AS PERC_SAB
FROM(
SELECT
  CODIGO,
  NOME,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Domingo' THEN SOMA_DIA ELSE 0 END) AS DOM,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Segunda' THEN SOMA_DIA ELSE 0 END) AS SEG,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Terça' THEN SOMA_DIA ELSE 0 END) AS TER,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Quarta' THEN SOMA_DIA ELSE 0 END) AS QUA,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Quinta' THEN SOMA_DIA ELSE 0 END) AS QUI,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Sexta' THEN SOMA_DIA ELSE 0 END) AS SEX,
  SUM(CASE WHEN DIAS_DA_SEMANA = 'Sábado' THEN SOMA_DIA ELSE 0 END) AS SAB,
  MAX(SOMA) AS TOTAL
FROM BASE
GROUP BY NOME, CODIGO
ORDER BY NOME
) AS SUB;

	