WITH FATURAMENTO AS (
SELECT
  DC.PESSOA_DOCCOM AS COD_SUPERVISOR,
  CASE 
	  WHEN P.RAZAOSOCIAL_PESSOA = 'REGINALDO LEAL GOMES' THEN 'REGINALDO' 
  	  WHEN P.RAZAOSOCIAL_PESSOA = 'GEAN ORTIZ DE MORAIS' THEN 'GEAN'
  	  WHEN P.RAZAOSOCIAL_PESSOA = 'MARCO AURELIO SANTOS RIBEIRO' THEN 'MARCO'
  	  WHEN P.RAZAOSOCIAL_PESSOA = 'SUPERVISOR - EXPORTAÇÃO' THEN 'EXP.'
  	  WHEN P.RAZAOSOCIAL_PESSOA = 'SUPERVISOR - ECOMMERCE' THEN 'ECO.'
  END AS NOME_SUPERVISOR,
  SUM(DF.VLRLIQUIDO_DOCFAT) AS VALOR_VENDIDO,
  CASE 
  WHEN Filtro(2) = 'S' THEN 20
  WHEN Filtro(3) = 'S' THEN 20  
  WHEN Filtro(4) = 'S' THEN 19  
  WHEN Filtro(5) = 'S' THEN 20  
  WHEN Filtro(6) = 'S' THEN 21  
  WHEN Filtro(7) = 'S' THEN 20  
  WHEN Filtro(8) = 'S' THEN 23  
  WHEN Filtro(9) = 'S' THEN 21  
  WHEN Filtro(10) = 'S' THEN 21 
  WHEN Filtro(11) = 'S' THEN 22 
  WHEN Filtro(12) = 'S' THEN 20 
  WHEN Filtro(13) = 'S' THEN 22 
END AS DIAS_UTEIS_MES,
  COUNT(DISTINCT DC_CONS.PESSOA_DOCCOM) FILTER(WHERE DC_CONS.PESSOA_DOCCOM NOT IN (/*Reginaldo*/55619,50936,42158,55171,40978,47241,50188, /*Gean*/40979,56583, /*Marco*/40980,56584) ) AS QTDE_REP_VENDAS,
  COUNT(DISTINCT DF.CLIENTE_DOCFAT) AS QTDE_CLIENTES
FROM DOCUMENTO_FATURA DF
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT AND DC.TIPOPESSOA_DOCCOM = 1 AND DC.PESSOA_DOCCOM IN (34994,35686,54773,52987,53019)
  INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
  INNER JOIN DOCUMENTO_COMISSAO DC_CONS ON DC_CONS.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT AND DC_CONS.TIPOPESSOA_DOCCOM = 0
  INNER JOIN PESSOA P_CONS ON P_CONS.CODIGO_PESSOA = DC_CONS.PESSOA_DOCCOM
WHERE                   
  EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = Filtro(1) AND
  (
    (Filtro(2) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 1) OR
    (Filtro(3) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 2) OR
    (Filtro(4) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3) OR
    (Filtro(5) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 4) OR
    (Filtro(6) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 5) OR
    (Filtro(7) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 6) OR
    (Filtro(8) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 7) OR
    (Filtro(9) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 8) OR
    (Filtro(10) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 9) OR
    (Filtro(11) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 10) OR
    (Filtro(12) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 11) OR
    (Filtro(13) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 12)
  ) AND
  DF.CLASSIFICACAO_DOCFAT IN (1, 2, 5) AND
  Filtro(14,'DC.PESSOA_DOCCOM')
GROUP BY
  DC.PESSOA_DOCCOM,
  P.RAZAOSOCIAL_PESSOA
),
CONSULTORES_ATIVOS AS (
SELECT
  PCS.SUPERVISOR_PESSOA_CONSUP AS COD_SUPERVISOR,
  COUNT(DISTINCT PCS.CONSULTOR_PESSOA_CONSUP) AS QTDE_CONSULTORES_ATIVOS
FROM PESSOA P
  INNER JOIN PESSOA_CONSULTORSUPERVISOR PCS ON PCS.CONSULTOR_PESSOA_CONSUP = P.CODIGO_PESSOA
WHERE STATUS_PESSOA = 0
  AND PCS.CONSULTOR_PESSOA_CONSUP NOT IN (/*Reginaldo*/55619,50936,42158,55171,40978,47241,50188, /*Gean*/40979,56583, /*Marco*/40980,56584)
GROUP BY
  PCS.SUPERVISOR_PESSOA_CONSUP
),
CANCELADO AS (
SELECT
  DC.PESSOA_DOCCOM AS COD_SUP,
  P.RAZAOSOCIAL_PESSOA AS NOME_SUP,
  SUM(DID.VLRUNITARIOLIQUIDO_DOCITEMDET * DID.QTDECANCELADO_DOCITEMDET) AS VALOR_CANCELADO
FROM DOCUMENTO_FATURA DF
  LEFT JOIN DOCUMENTO_DEVOLUCAOCANCELA DDC ON DF.CODIGO_DOCFAT = DDC.DOCUMENTO_DOCDEV
  LEFT JOIN DOCUMENTO_ITEM_DETALHE DID ON DID.AUTOINC_DOCITEMDET = DDC.AUTOINCITEMDETDOC_DOCDEV
  LEFT JOIN DOCUMENTO_ITEM DI ON DI.AUTOINC_DOCITEM = DID.AUTOINCITEM_DOCITEMDET
  LEFT JOIN DOCUMENTO_FATURA DF_P ON DF_P.CODIGO_DOCFAT = DI.DOCUMENTO_DOCITEM
  LEFT JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF_P.CODIGO_DOCFAT AND DC.TIPOPESSOA_DOCCOM = 1 AND DC.PRINCIPAL_DOCCOM = 'S'
  LEFT JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
WHERE
  EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = Filtro(1) AND
  (
    (Filtro(2) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 1) OR
    (Filtro(3) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 2) OR
    (Filtro(4) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3) OR
    (Filtro(5) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 4) OR
    (Filtro(6) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 5) OR
    (Filtro(7) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 6) OR
    (Filtro(8) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 7) OR
    (Filtro(9) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 8) OR
    (Filtro(10) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 9) OR
    (Filtro(11) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 10) OR
    (Filtro(12) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 11) OR
    (Filtro(13) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 12)
  ) AND
    DF.TIPO_DOCFAT = 1 AND
  DF.OPCAO_DOCFAT = 2 AND
  DF.UNIDFABRIL_DOCFAT = 1 AND
  DF.EMPRESA_DOCFAT = 2 AND
  Filtro(14,'DC.PESSOA_DOCCOM')
GROUP BY
  DC.PESSOA_DOCCOM,
  P.RAZAOSOCIAL_PESSOA
),
METAS AS (
SELECT
  P.CODIGO_PESSOA AS COD,
  P.RAZAOSOCIAL_PESSOA AS NM,
  (
    (CASE WHEN Filtro(2) = 'S' THEN MV.META_01_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(3) = 'S' THEN MV.META_02_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(4) = 'S' THEN MV.META_03_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(5) = 'S' THEN MV.META_04_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(6) = 'S' THEN MV.META_05_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(7) = 'S' THEN MV.META_06_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(8) = 'S' THEN MV.META_07_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(9) = 'S' THEN MV.META_08_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(10) = 'S' THEN MV.META_09_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(11) = 'S' THEN MV.META_10_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(12) = 'S' THEN MV.META_11_METASVEN ELSE 0 END) +
    (CASE WHEN Filtro(13) = 'S' THEN MV.META_12_METASVEN ELSE 0 END)
  ) AS META
FROM PESSOA P
  INNER JOIN METAS_VENDAS MV ON MV.CODIGO_METASVEN = P.CODIGO_PESSOA
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.PESSOA_DOCCOM = MV.CODIGO_METASVEN AND MV.TIPO_METASVEN = 1
WHERE 
  ANO_METASVEN = Filtro(1)
GROUP BY
  COD,
  NM,
  MV.META_01_METASVEN,
  MV.META_02_METASVEN,
  MV.META_03_METASVEN,
  MV.META_04_METASVEN,
  MV.META_05_METASVEN,
  MV.META_06_METASVEN,
  MV.META_07_METASVEN,
  MV.META_08_METASVEN,
  MV.META_09_METASVEN,
  MV.META_10_METASVEN,
  MV.META_11_METASVEN,
  MV.META_12_METASVEN
  ),
GERAL AS (
SELECT
  F.COD_SUPERVISOR,
  F.NOME_SUPERVISOR,
  F.VALOR_VENDIDO,
  M.META,
  (M.META / F.DIAS_UTEIS_MES) AS META_DIA,
  C.VALOR_CANCELADO,
  (F.VALOR_VENDIDO - COALESCE(C.VALOR_CANCELADO, 0)) AS RESULTADO_LIQUIDO,
  COALESCE(CA.QTDE_CONSULTORES_ATIVOS, 0) AS CONSULTORES_ATIVOS,
  F.QTDE_REP_VENDAS,
  F.QTDE_CLIENTES,
  F.DIAS_UTEIS_MES
FROM FATURAMENTO F
  LEFT JOIN METAS M ON M.COD = F.COD_SUPERVISOR
  LEFT JOIN CANCELADO C ON C.COD_SUP = F.COD_SUPERVISOR
  LEFT JOIN CONSULTORES_ATIVOS CA ON CA.COD_SUPERVISOR = F.COD_SUPERVISOR
GROUP BY
  F.COD_SUPERVISOR,
  F.NOME_SUPERVISOR,
  F.VALOR_VENDIDO,
  M.META,
  META_DIA,
  RESULTADO_LIQUIDO,
  CONSULTORES_ATIVOS,
  C.VALOR_CANCELADO,
  F.QTDE_REP_VENDAS,
  F.QTDE_CLIENTES,
  F.DIAS_UTEIS_MES
)
SELECT
  COD_SUPERVISOR,
  NOME_SUPERVISOR,
  VALOR_VENDIDO,
  SUM(VALOR_VENDIDO) OVER() AS SOMA_VALOR_VENDIDO,
  META,
  SUM(META) OVER() AS TOTAL_META,
  VALOR_CANCELADO,
  SUM(VALOR_CANCELADO) OVER() AS TOTAL_CANCELADO,
  RESULTADO_LIQUIDO,
  SUM(RESULTADO_LIQUIDO) OVER() AS TOTAL_LIQUIDO,
  CONSULTORES_ATIVOS,
  SUM(CONSULTORES_ATIVOS) OVER() AS TOTAL_ATIVOS,
  QTDE_REP_VENDAS,
  SUM(QTDE_REP_VENDAS) OVER() AS TOTAL_REP_VENDAS,
  QTDE_CLIENTES,
  SUM(QTDE_CLIENTES) /*FILTER(WHERE COD_SUPERVISOR IN (35686,54773,34994))*/OVER() AS TOTAL_CLIENTES,
  META_DIA,
  SUM(META_DIA) OVER() AS TOTAL_META_DIA,
  (META_DIA / CONSULTORES_ATIVOS) AS META_TICKET
FROM GERAL
ORDER BY VALOR_VENDIDO DESC;






WITH AJUSTADO AS (
  SELECT
    DF.*,
    DC.PESSOA_DOCCOM,
    P.RAZAOSOCIAL_PESSOA,
    CASE
      WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 6 THEN CAST(DF.DTEMISSAO_DOCFAT AS DATE) + 2
      WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 0 THEN CAST(DF.DTEMISSAO_DOCFAT AS DATE) + 1
      ELSE CAST(DF.DTEMISSAO_DOCFAT AS DATE)
    END AS DATA_BASE
  FROM DOCUMENTO_FATURA DF
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT
    AND DC.TIPOPESSOA_DOCCOM = 1
    AND DC.PESSOA_DOCCOM IN (34994, 35686, 54773)
  INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
  WHERE
    EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = Filtro(1) AND
  (
    (Filtro(2) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 1) OR
    (Filtro(3) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 2) OR
    (Filtro(4) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3) OR
    (Filtro(5) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 4) OR
    (Filtro(6) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 5) OR
    (Filtro(7) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 6) OR
    (Filtro(8) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 7) OR
    (Filtro(9) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 8) OR
    (Filtro(10) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 9) OR
    (Filtro(11) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 10) OR
    (Filtro(12) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 11) OR
    (Filtro(13) = 'S' AND EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 12)
  ) AND
  DF.CLASSIFICACAO_DOCFAT IN (1, 2, 5) AND
  Filtro(14,'DC.PESSOA_DOCCOM')
),
DIAS_VALIDOS AS (
  SELECT DISTINCT
    EXTRACT(DAY FROM 
      CASE
        WHEN AJUSTADO.DATA_BASE IN (DATE '2025-01-01', DATE '2025-01-02', DATE '2025-01-03') THEN DATE '2025-01-06'  
        WHEN AJUSTADO.DATA_BASE IN (DATE '2025-03-03', DATE '2025-03-04') THEN DATE '2025-03-05'
        WHEN AJUSTADO.DATA_BASE IN (DATE '2025-04-18', DATE '2025-04-21') THEN DATE '2025-04-22'
        WHEN AJUSTADO.DATA_BASE = DATE '2025-05-01' THEN DATE '2025-05-02'
        WHEN AJUSTADO.DATA_BASE = DATE '2025-06-19' THEN DATE '2025-06-20'
        WHEN AJUSTADO.DATA_BASE = DATE '2025-10-10' THEN DATE '2025-10-13'
        WHEN AJUSTADO.DATA_BASE = DATE '2025-11-20' THEN DATE '2025-11-21'
        WHEN AJUSTADO.DATA_BASE = DATE '2025-12-25' THEN DATE '2025-12-26'
        ELSE AJUSTADO.DATA_BASE
      END
    ) AS DIA
  FROM AJUSTADO
),
CONTAGEM_DIAS AS (
  SELECT COUNT(*) AS DIAS_COM_RESULTADO FROM DIAS_VALIDOS
)

SELECT
  AJUSTADO.PESSOA_DOCCOM AS CD_SUPERVISOR,
  CASE 
    WHEN AJUSTADO.RAZAOSOCIAL_PESSOA = 'REGINALDO LEAL GOMES' THEN 'REGINALDO' 
    WHEN AJUSTADO.RAZAOSOCIAL_PESSOA = 'GEAN ORTIZ DE MORAIS' THEN 'GEAN'
    WHEN AJUSTADO.RAZAOSOCIAL_PESSOA = 'MARCO AURELIO SANTOS RIBEIRO' THEN 'MARCO'
  END AS NM_SUPERVISOR,
  EXTRACT(DAY FROM 
    CASE
      WHEN AJUSTADO.DATA_BASE IN (DATE '2025-01-01', DATE '2025-01-02', DATE '2025-01-03') THEN DATE '2025-01-06'  
      WHEN AJUSTADO.DATA_BASE IN (DATE '2025-03-03', DATE '2025-03-04') THEN DATE '2025-03-05'
      WHEN AJUSTADO.DATA_BASE IN (DATE '2025-04-18', DATE '2025-04-21') THEN DATE '2025-04-22'
      WHEN AJUSTADO.DATA_BASE = DATE '2025-05-01' THEN DATE '2025-05-02'
      WHEN AJUSTADO.DATA_BASE = DATE '2025-06-19' THEN DATE '2025-06-20'
      WHEN AJUSTADO.DATA_BASE = DATE '2025-10-10' THEN DATE '2025-10-13'
      WHEN AJUSTADO.DATA_BASE = DATE '2025-11-20' THEN DATE '2025-11-21'
      WHEN AJUSTADO.DATA_BASE = DATE '2025-12-25' THEN DATE '2025-12-26'
      ELSE AJUSTADO.DATA_BASE
    END
  ) AS DIA_AJUSTADO,
  SUM(AJUSTADO.VLRLIQUIDO_DOCFAT) AS SOMA,
  CONTAGEM_DIAS.DIAS_COM_RESULTADO,
  CASE 
    WHEN Filtro(2) = 'S' THEN 20
    WHEN Filtro(3) = 'S' THEN 20  
    WHEN Filtro(4) = 'S' THEN 19  
    WHEN Filtro(5) = 'S' THEN 20  
    WHEN Filtro(6) = 'S' THEN 21  
    WHEN Filtro(7) = 'S' THEN 20  
    WHEN Filtro(8) = 'S' THEN 23  
    WHEN Filtro(9) = 'S' THEN 21  
    WHEN Filtro(10) = 'S' THEN 21 
    WHEN Filtro(11) = 'S' THEN 22 
    WHEN Filtro(12) = 'S' THEN 20 
    WHEN Filtro(13) = 'S' THEN 22 
  END AS DIAS_UTEIS_MES
FROM AJUSTADO
JOIN CONTAGEM_DIAS ON 1=1
GROUP BY
  AJUSTADO.PESSOA_DOCCOM,
  AJUSTADO.RAZAOSOCIAL_PESSOA,
  DIA_AJUSTADO,
  CONTAGEM_DIAS.DIAS_COM_RESULTADO
ORDER BY DIA_AJUSTADO;