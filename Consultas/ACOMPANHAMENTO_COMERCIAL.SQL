SELECT
	--DF.CODIGO_DOCFAT,
	SUM(DF.VLRLIQUIDO_DOCFAT) AS SOMA,
	EXTRACT(DAY FROM DF.DTEMISSAO_DOCFAT) AS DIA,
	EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) AS MES,
	EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) AS ANO
FROM DOCUMENTO_FATURA DF
WHERE 
	EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3 AND
	EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = 2025 AND
	DF.CLASSIFICACAO_DOCFAT IN (1, 2, 5)
GROUP BY
	DF.CODIGO_DOCFAT,
	EXTRACT(DAY FROM DF.DTEMISSAO_DOCFAT), 
	EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT), 
	EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT);

SELECT * FROM DOCUMENTO_FATURA;

SELECT
DC.PESSOA_DOCCOM AS COD_SUPERVISOR,
P.RAZAOSOCIAL_PESSOA AS NOME_SUPERVISOR,
EXTRACT(DAY FROM
CASE
	WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 6 THEN DF.DTEMISSAO_DOCFAT + 2
	WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 0 THEN DF.DTEMISSAO_DOCFAT + 1
	ELSE DF.DTEMISSAO_DOCFAT
	END
) AS DIA_AJUSTADO,
    SUM(DF.VLRLIQUIDO_DOCFAT) AS SOMA
FROM DOCUMENTO_FATURA DF
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT AND DC.TIPOPESSOA_DOCCOM = 1 AND DC.PESSOA_DOCCOM NOT IN (/*Thiago*/34983,53019,52987)
  INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
WHERE
    EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3 AND
    EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = 2025 AND
    DF.CLASSIFICACAO_DOCFAT IN (1, 2, 5)
GROUP BY
	DC.PESSOA_DOCCOM,
	P.RAZAOSOCIAL_PESSOA,
	DIA_AJUSTADO
	
SELECT
  COD_SUPERVISOR,
  NOME_SUPERVISOR,
  EXTRACT(DAY FROM DIA_AJUSTADO) AS DIA_AJUSTADO,
  SUM(SOMA) AS SOMA
FROM (
  SELECT
    DC.PESSOA_DOCCOM AS COD_SUPERVISOR,
    P.RAZAOSOCIAL_PESSOA AS NOME_SUPERVISOR,
    CASE
      WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 6 THEN DF.DTEMISSAO_DOCFAT + 2
      WHEN EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 0 THEN DF.DTEMISSAO_DOCFAT + 1
      WHEN DF.DTEMISSAO_DOCFAT IN (DATE '2025-03-03', DATE '2025-03-04', DATE '2025-03-28') AND EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 1 THEN DF.DTEMISSAO_DOCFAT + 1
      WHEN DF.DTEMISSAO_DOCFAT IN (DATE '2025-03-03', DATE '2025-03-04', DATE '2025-03-28') AND EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 2 THEN DF.DTEMISSAO_DOCFAT + 1
      WHEN DF.DTEMISSAO_DOCFAT IN (DATE '2025-03-03', DATE '2025-03-04', DATE '2025-03-28') AND EXTRACT(WEEKDAY FROM DF.DTEMISSAO_DOCFAT) = 5 THEN DF.DTEMISSAO_DOCFAT + 3
      ELSE DF.DTEMISSAO_DOCFAT
    END AS DIA_AJUSTADO,
    DF.VLRLIQUIDO_DOCFAT AS SOMA
  FROM DOCUMENTO_FATURA DF
  INNER JOIN DOCUMENTO_COMISSAO DC 
    ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT 
    AND DC.TIPOPESSOA_DOCCOM = 1 
    AND DC.PESSOA_DOCCOM NOT IN (34983,53019,52987)
  INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
) AJUSTADO
WHERE
  EXTRACT(MONTH FROM DIA_AJUSTADO) = 3 AND
  EXTRACT(YEAR FROM DIA_AJUSTADO) = 2025
GROUP BY
  COD_SUPERVISOR,
  NOME_SUPERVISOR,
  EXTRACT(DAY FROM DIA_AJUSTADO)


 SELECT * FROM diasnaouteis;

WITH FATURAMENTO AS (
SELECT
  DC.PESSOA_DOCCOM AS COD_SUPERVISOR,
  P.RAZAOSOCIAL_PESSOA AS NOME_SUPERVISOR,
  SUM(DF.VLRLIQUIDO_DOCFAT) AS VALOR_VENDIDO,
  COUNT(DISTINCT DC_CONS.PESSOA_DOCCOM) FILTER(WHERE DC_CONS.PESSOA_DOCCOM NOT IN (/*Reginaldo*/55619,50936,42158,55171,40978,47241,50188, /*Gean*/40979,56583, /*Marco*/40980,56584) ) AS QTDE_REP_VENDAS
FROM DOCUMENTO_FATURA DF
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT AND DC.TIPOPESSOA_DOCCOM = 1 AND DC.PESSOA_DOCCOM NOT IN (/*Thiago*/34983)
  INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
  INNER JOIN DOCUMENTO_COMISSAO DC_CONS ON DC_CONS.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT AND DC_CONS.TIPOPESSOA_DOCCOM = 0
  INNER JOIN PESSOA P_CONS ON P_CONS.CODIGO_PESSOA = DC_CONS.PESSOA_DOCCOM
WHERE
  EXTRACT(YEAR FROM DF.DTEMISSAO_DOCFAT) = 2025 AND
  EXTRACT(MONTH FROM DF.DTEMISSAO_DOCFAT) = 3 AND
  DF.CLASSIFICACAO_DOCFAT IN (1, 2, 5)
GROUP BY
  DC.PESSOA_DOCCOM,
  P.RAZAOSOCIAL_PESSOA
),
CANCELADO AS (
SELECT
  DC.PESSOA_DOCCOM AS COD_SUP,
  P.RAZAOSOCIAL_PESSOA AS NOME_SUP,
  SUM(DID.VLRUNITARIOLIQUIDO_DOCITEMDET * DID.QTDECANCELADO_DOCITEMDET) AS VALOR_CANCELADO
FROM DOCUMENTO_FATURA DF
  LEFT JOIN DOCUMENTO_DEVOLUCAOCANCELA DDC ON DF.CODIGO_DOCFAT = DDC.DOCUMENTO_DOCDEV
  LEFT JOIN DOCUMENTO_ITEM_DETALHE DID ON DID.AUTOINC_DOCITEMDET = DDC.AUTOINCITEMDETDOC_DOCDEV
  LEFT JOIN DOCUMENTO_ITEM DI ON DI.AUTOINC_DOCITEM = DID.AUTOINCITEM_DOCITEMDET
  LEFT JOIN DOCUMENTO_FATURA DF_P ON DF_P.CODIGO_DOCFAT = DI.DOCUMENTO_DOCITEM
  LEFT JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF_P.CODIGO_DOCFAT AND DC.TIPOPESSOA_DOCCOM = 1 AND DC.PRINCIPAL_DOCCOM = 'S'
  LEFT JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
WHERE
  EXTRACT(YEAR FROM DF.DATACONFERENCIA_DOCFAT ) = 2025 AND
  EXTRACT(MONTH FROM DF.DATACONFERENCIA_DOCFAT ) = 3 AND
  DF.TIPO_DOCFAT = 1 AND
  DF.OPCAO_DOCFAT = 2 AND
  DF.UNIDFABRIL_DOCFAT = 1 AND
  DF.EMPRESA_DOCFAT = 2
GROUP BY
  DC.PESSOA_DOCCOM,
  P.RAZAOSOCIAL_PESSOA
),
METAS AS (
SELECT
  P.CODIGO_PESSOA AS COD,
  P.RAZAOSOCIAL_PESSOA AS NM,
  MV.META_03_METASVEN
FROM PESSOA P
  INNER JOIN METAS_VENDAS MV ON MV.CODIGO_METASVEN = P.CODIGO_PESSOA
  INNER JOIN DOCUMENTO_COMISSAO DC ON DC.PESSOA_DOCCOM = MV.CODIGO_METASVEN AND MV.TIPO_METASVEN = 1
WHERE 
  ANO_METASVEN = 2025
GROUP BY
  COD,
  NM,
  MV.META_03_METASVEN
)
SELECT
  F.COD_SUPERVISOR,
  F.NOME_SUPERVISOR,
  M.META_03_METASVEN,
  F.VALOR_VENDIDO,
  --M.META_TOTAL,
  C.VALOR_CANCELADO,
  (F.VALOR_VENDIDO - C.VALOR_CANCELADO) AS RESULTADO_LIQUIDO_MES,
  F.QTDE_REP_VENDAS
FROM FATURAMENTO F
LEFT JOIN METAS M ON M.COD = F.COD_SUPERVISOR
LEFT JOIN CANCELADO C ON C.COD_SUP = F.COD_SUPERVISOR
--CROSS JOIN DIAS_UTEIS D;
ORDER BY VALOR_VENDIDO DESC


