WITH FATURAMENTO AS (
  SELECT
    DC.PESSOA_DOCCOM AS CONSULTOR,
    P.RAZAOSOCIAL_PESSOA AS NOME,
    DC.TIPOPESSOA_DOCCOM AS TIPO,
    SUM(NF.VALORTOTAL_NF) AS VALOR_VENDIDO,
    DC_SUPER.PESSOA_DOCCOM AS COD_SUPER,
    SUPERVISOR.RAZAOSOCIAL_PESSOA AS NOME_SUPER
  FROM NOTA_FISCAL NF
    INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
    INNER JOIN DOCUMENTO_COMISSAO DC ON DC.DOCUMENTO_DOCCOM = DF.CODIGO_DOCFAT
    INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DC.PESSOA_DOCCOM
    INNER JOIN DOCUMENTO_COMISSAO DC_SUPER ON DC.DOCUMENTO_DOCCOM = DC_SUPER.DOCUMENTO_DOCCOM AND DC_SUPER.TIPOPESSOA_DOCCOM = 1
    INNER JOIN PESSOA SUPERVISOR ON SUPERVISOR.CODIGO_PESSOA = DC_SUPER.PESSOA_DOCCOM
  WHERE
    EXTRACT(YEAR FROM NF.DATAEMISSAO_NF) = Filtro(1) AND
    (
      (Filtro(2) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 1) OR
      (Filtro(3) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 2) OR
      (Filtro(4) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 3) OR
      (Filtro(5) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 4) OR
      (Filtro(6) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 5) OR
      (Filtro(7) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 6) OR
      (Filtro(8) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 7) OR
      (Filtro(9) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 8) OR
      (Filtro(10) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 9) OR
      (Filtro(11) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 10) OR
      (Filtro(12) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 11) OR
      (Filtro(13) = 'S' AND EXTRACT(MONTH FROM NF.DATAEMISSAO_NF) = 12)
    ) AND
    NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
    DF.CLASSIFICACAO_DOCFAT = 1 AND
    DC.TIPOPESSOA_DOCCOM = 0 AND
    Filtro(14,'DC_SUPER.PESSOA_DOCCOM') AND
    Filtro(15,'DC.PESSOA_DOCCOM')
  GROUP BY
    COD_SUPER,
    NOME_SUPER,
    DC.PESSOA_DOCCOM,
    P.RAZAOSOCIAL_PESSOA,
    DC.TIPOPESSOA_DOCCOM
),
METAS AS (
  SELECT
    P.CODIGO_PESSOA AS COD,
    P.RAZAOSOCIAL_PESSOA AS NM,
    (
      (CASE WHEN Filtro(2) = 'S' THEN MV.META_01_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(3) = 'S' THEN MV.META_02_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(4) = 'S' THEN MV.META_03_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(5) = 'S' THEN MV.META_04_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(6) = 'S' THEN MV.META_05_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(7) = 'S' THEN MV.META_06_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(8) = 'S' THEN MV.META_07_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(9) = 'S' THEN MV.META_08_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(10) = 'S' THEN MV.META_09_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(11) = 'S' THEN MV.META_10_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(12) = 'S' THEN MV.META_11_METASVEN ELSE 0 END) +
      (CASE WHEN Filtro(13) = 'S' THEN MV.META_12_METASVEN ELSE 0 END)
    ) AS META_TOTAL
  FROM PESSOA P
    INNER JOIN METAS_VENDAS MV ON MV.CODIGO_METASVEN = P.CODIGO_PESSOA
    INNER JOIN DOCUMENTO_COMISSAO DC ON DC.PESSOA_DOCCOM = MV.CODIGO_METASVEN
  WHERE 
    ANO_METASVEN = Filtro(1)
  GROUP BY
    COD,
    NM,
    MV.META_01_METASVEN,
    MV.META_02_METASVEN,
    MV.META_03_METASVEN,
    MV.META_04_METASVEN,
    MV.META_05_METASVEN,
    MV.META_06_METASVEN,
    MV.META_07_METASVEN,
    MV.META_08_METASVEN,
    MV.META_09_METASVEN,
    MV.META_10_METASVEN,
    MV.META_11_METASVEN,
    MV.META_12_METASVEN
)
SELECT
  F.COD_SUPER,
  F.NOME_SUPER,
  F.CONSULTOR,
  F.NOME,
  F.TIPO,
  F.VALOR_VENDIDO,
  SUM(F.VALOR_VENDIDO) OVER() AS TOTAL,
  M.META_TOTAL,
  SUM(M.META_TOTAL) OVER() AS META_TUDO
FROM FATURAMENTO F
  LEFT JOIN METAS M ON M.COD = F.CONSULTOR
GROUP BY
  F.COD_SUPER,
  F.NOME_SUPER,
  F.CONSULTOR,
  F.NOME,
  F.TIPO,
  F.VALOR_VENDIDO,
  M.META_TOTAL