WITH COMPRAS AS(
SELECT
	DF.CLIENTE_DOCFAT AS CLIENTE,
	R.DESCRICAO_REGIAO AS REGIAO,
	DC.DTVENDA_DOCPED AS DT_VENDA,
	ROW_NUMBER() OVER(PARTITION BY DF.CLIENTE_DOCFAT ORDER BY DC.DTVENDA_DOCPED DESC) AS RN
FROM NOTA_FISCAL NF
    INNER JOIN DOCUMENTO_FATURA DF ON DF.CODIGO_DOCFAT = NF.LISTA_PEDIDOS_NF AND NF.LISTA_PEDIDOS_NF NOT LIKE '%/%'
    INNER JOIN DOCUMENTO_PEDIDO DC ON DC.DOCUMENTO_DOCPED = DF.CODIGO_DOCFAT
    INNER JOIN PESSOA P ON P.CODIGO_PESSOA = DF.CLIENTE_DOCFAT
    INNER JOIN PESSOA_ENDERECO PE ON PE.AUTOINC_PESSOA_END = NF.ENDERECO_NF
    INNER JOIN REGIAO R ON R.CODIGO_REGIAO = PE.REGIAO_PESSOA_END
WHERE 
    NF.TRANSACAO_NF IN (2,20,110,119,121,350) AND
    DF.CLASSIFICACAO_DOCFAT = 1 AND
    P.TIPO_PESSOA = 'J' AND
	P.STATUS_PESSOA = 0
),
SEM_REPETICAO_POR_DIA AS (
SELECT
	CLIENTE,
	REGIAO,
	DT_VENDA,
	RN
FROM (
	SELECT
		CLIENTE,
		REGIAO,
		DT_VENDA,
		RN,
		ROW_NUMBER() OVER(PARTITION BY CLIENTE, DT_VENDA ORDER BY DT_VENDA) AS RN_DIA
	FROM COMPRAS
	) SUB
	WHERE RN_DIA = 1
),
ULTIMAS_5_COMPRAS AS (
SELECT
	CLIENTE,
	REGIAO,
	DT_VENDA,
	RN
FROM SEM_REPETICAO_POR_DIA
WHERE RN <=5
),
INTERVALOS AS (
SELECT
	CLIENTE,
	REGIAO,
	MAX(CASE WHEN RN = 1 THEN DT_VENDA END) AS COMPRA_1,
	MAX(CASE WHEN RN = 2 THEN DT_VENDA END) AS COMPRA_2,
	MAX(CASE WHEN RN = 3 THEN DT_VENDA END) AS COMPRA_3,
	MAX(CASE WHEN RN = 4 THEN DT_VENDA END) AS COMPRA_4,
	MAX(CASE WHEN RN = 5 THEN DT_VENDA END) AS COMPRA_5
FROM ULTIMAS_5_COMPRAS
GROUP BY 
	CLIENTE, 
	REGIAO
),
COMPARATIVO AS (
SELECT	
    CLIENTE,
    REGIAO,
	COMPRA_1,
	COMPRA_2,
	COMPRA_3,
	COMPRA_4,
	COMPRA_5,
	DATEDIFF(DAY, COMPRA_2, COMPRA_1) AS DIAS_1_2,
	DATEDIFF(DAY, COMPRA_3, COMPRA_2) AS DIAS_2_3,
	DATEDIFF(DAY, COMPRA_4, COMPRA_3) AS DIAS_3_4,
	DATEDIFF(DAY, COMPRA_5, COMPRA_4) AS DIAS_4_5,
	DATEDIFF(DAY, COMPRA_1, CURRENT_DATE) AS DIAS_SEM_COMPRAR
FROM INTERVALOS
)
SELECT
	CLIENTE,
	REGIAO,
	COMPRA_1,
	COMPRA_2,
	COMPRA_3,
	COMPRA_4,
	COMPRA_5,
	DIAS_1_2,
	DIAS_2_3,
	DIAS_3_4,
	DIAS_4_5,
	DIAS_SEM_COMPRAR,
	CASE
		WHEN DIAS_SEM_COMPRAR >= Filtro(1) * 0.80 THEN '1-Vermelho'
		WHEN DIAS_SEM_COMPRAR >= Filtro(1) * 0.50 THEN '2-Amarelo'
		ELSE '3-Verde'
		END AS STATUS
FROM COMPARATIVO
WHERE 
	COMPRA_1 IS NOT NULL AND 
	COMPRA_2 IS NOT NULL AND
	COMPRA_3 IS NOT NULL AND
	COMPRA_4 IS NOT NULL AND 
	COMPRA_5 IS NOT NULL AND
	DIAS_SEM_COMPRAR < Filtro(1);
    
    